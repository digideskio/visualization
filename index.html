<html>
<head>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.12/themes/css/cartodb.css" />
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.12/cartodb.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAjU0EJWnWPMv7oQ-jjS7dYxSPW5CJgpdgO_s4yyMovOaVh_KvvhSfpvagV18eOyDWu7VytS6Bi1CWxw"
      type="text/javascript"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
    <![endif]-->
    <style>
        html, body {width:100%; height:100%; padding: 0; margin: 0;}
        #cartodb-map { width: 100%; height:100%; background: black;}
    </style>
</head>
<body>
    <div class="row">
        <div class="col-md-3">
            <div style="padding:10px">
                <form class="form" action="#" onsubmit="getRoute(this.address.value); return false">
                    <input type="text" class="form-control" name="address" value="Cornell Tech, New York City, NY" />
                    <br/>
                    <input class="btn btn-primary" type="submit" value="Go!" />
                </form>
            </div>
        </div>
        <div class="col-md-9">
            <div id='cartodb-map'></div>
        </div>
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>
        var map = new L.Map('cartodb-map', { 
            center: [0,0],
            zoom: 10
        })

        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        function deletePoint(id) {
            map.removeLayer(id);
            return false;
        }
        
        function deletePath(path) {
            while(path.length > 0) {
                var line = path.pop();
                deletePoint(line);
            }
        }

        var current = L.circle([0,0],12);
        var path = [];

        function getCurrentLocation() {
            navigator.geolocation.getCurrentPosition(function (position) {
                var coords = [position.coords.latitude, position.coords.longitude]
                current = L.circle(coords, 12, {color: 'blue'}).addTo(map);
                map.panTo(coords);
                map.setZoom(18);
            });
        }
        getCurrentLocation()
        
        var geocoder = new GClientGeocoder();
        var test = null;
        function getRoute(address) {
            deletePoint(current);
            deletePath(path);
            if (geocoder) {
                geocoder.getLatLng(
                    address,
                    function(point) {
                        if (!point) {
                            alert(address + " not found");
                        } else {
                            var curr_lat = current.getLatLng()['lat'];
                            var curr_lng = current.getLatLng()['lng'];
                            
                            var marker = new GMarker(point, {draggable: true}).getLatLng();
                            var dest_lat = marker.k;
                            var dest_lng = marker.D;
//                            L.circleMarker(L.latLng(lat,lon)).addTo(map);
                            console.log(curr_lat,curr_lng,dest_lat,dest_lng);
                            $.ajax({
                                url: 'http://52.1.185.143:8080/query',
                                data: {
                                    curr_lat : curr_lat,
                                    curr_lng : curr_lng,
                                    dest_lat : dest_lat,
                                    dest_lng : dest_lng,
                                },
                                error: function() {
                                    console.log("ERROR");
                                },
                                dataType: 'json',
                                success: function(data) {
                                    console.log(data);
                                    addPath(data['coords']);
                                },
                                type: 'POST'
                            });
                        }
                    }
                );
            }
        };
        
         
        function addPath(coords) {
            var i = coords.length - 1;
            path.push(L.circle(coords[0], 12, {color: 'blue'}).addTo(map));
            path.push(L.circle(coords[i], 12, {color: 'green'}).addTo(map));
            for (var k = 0; k < i; k++) {
                path.push(L.polyline([coords[k],coords[k+1]]).addTo(map));
            }  

            map.fitBounds([
                coords[0],
                coords[i]
            ]);
        };
        
        function plotArray(coords,risks) {

            var circle = L.circle(coords[0],30,{color: 'blue'}).addTo(map);
            var i = coords.length;
            var circle2 = L.circle(coords[i-1],30,{color: 'green'}).addTo(map);
            // var polyline = L.polyline(coords, {color: d3.interpolateLab("red", "yellow")(.5)}).addTo(map);
            //map.fitBounds(polyline.getBounds()); 
            var polylines = [];
            var avg_risk = 0;
            var relativeRisk = d3.scale.linear()
            .domain([0.0,4000.0])
            .range([-1,1]);

            for (var k = 0; k < risks.length-1; k++) {
              avg_risk =  relativeRisk((risks[k]+risks[k+1])/2);
              if (avg_risk<1){
                //if bad, color is on red-yellow
                polyline = L.polyline([coords[k],coords[k+1]],
               {color: d3.interpolateLab("red", "yellow")(avg_risk+1)})
               .addTo(map);
              }
              else{
                //must be good (0,1), so color on yellow-green
                polyline = L.polyline([coords[k],coords[k+1]],
               {color: d3.interpolateLab("yellow", "green")(avg_risk)})
               .addTo(map);
              }
            }  

            var l = coords.length;
            map.fitBounds([
            coords[0],
            coords[i-1]
            ]);
          };


    </script>
</body>
</html>
