<html>
<head>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAjU0EJWnWPMv7oQ-jjS7dYxSPW5CJgpdgO_s4yyMovOaVh_KvvhSfpvagV18eOyDWu7VytS6Bi1CWxw"
      type="text/javascript"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
    <![endif]-->
    <style>
        html, body {width:100%; height:100%; padding: 0; margin: 0;}
        #cartodb-map { width: 100%; height:100%; background: black;}
    </style>
</head>
<body>
    <div class="row">
        <div class="col-md-3">
            <div style="padding:10px">
                <form class="form" action="#" onsubmit="getRoute(this.address.value); return false">
                    <input type="text" class="form-control" name="address" value="Cornell Tech, New York City, NY" />
                    <br/>
                    <input class="btn btn-primary" type="submit" value="Go!" />
                </form>
            </div>
        </div>
        <div class="col-md-9">
            <div id='cartodb-map'></div>
        </div>
    </div>
    <script>
        var map = new L.Map('cartodb-map', { 
            center: [0,0],
            zoom: 10
        })

//        L.tileLayer('https://dnv9my2eseobd.cloudfront.net/v3/cartodb.map-4xtxp73f/{z}/{x}/{y}.png', {
//            attribution: 'Mapbox <a href="http://mapbox.com/about/maps" target="_blank">Terms &amp; Feedback</a>'
//        }).addTo(map);

        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
            
        function deletePolygon(id) {
            map.removeLayer(id);
            return false;
        }
        
        var current = L.circle([0,0],12);
        var destination = L.circle([0,0],12);
        var path = L.polyline([current, destination], {color: 'blue'});

        function getCurrentLocation() {
            navigator.geolocation.getCurrentPosition(function (position) {
                var coords = [position.coords.latitude, position.coords.longitude]
                map.panTo(coords);
                map.setZoom(18);
                current = L.circle(coords, 12, {color: 'blue'}).addTo(map);
            });
        }
        getCurrentLocation();
        
        var geocoder = new GClientGeocoder();
        
        function getRoute(address) {
            deletePolygon(destination);
            deletePolygon(path);
            if (geocoder) {
                geocoder.getLatLng(
                    address,
                    function(point) {
                        if (!point) {
                            alert(address + " not found");
                        } else {
                            var marker = new GMarker(point, {draggable: true}).getLatLng();
                            var lat = marker.k;
                            var lon = marker.D;
//                            L.circleMarker(L.latLng(lat,lon)).addTo(map);
                            destination = L.circle([lat, lon], 12, {color: 'green'}).addTo(map);
                            path = L.polyline([current.getLatLng(), destination.getLatLng()], {color: 'yellow'}).addTo(map);
                            map.fitBounds(path.getBounds());
//                                  .bindPopup("I am a marker to be deleted.").openPopup();
                        }
                    }
                );
            }
        };

          path = [[40.741668,-74.001129],[40.742254,-74.000703],[40.742839,-74.000275],[40.743425,-73.999848],[40.744009,-73.999422],[40.744630,-73.998972],[40.745294,-73.998486],[40.745951,-73.998007],[40.746580,-73.997550],[40.745383,-73.994709],[40.746004,-73.994262],[40.746618,-73.993813],[40.745421,-73.990968],[40.746038,-73.990518],[40.746659,-73.990067],[40.747277,-73.989617],[40.746789,-73.988452]];
            risks = [256.365,1650.4,1633.43,217.13,36.6768,665.89,3729.57,3610.72,1861.07,2703.54,1743.49,380.741,2309.7,3853.3,2395.15,1635.78,1857.1];

            //plotArray(path,risks);

            /*var i = path.length;
            console.log(i);
            map.fitBounds([
            path[0],
            path[i-1]
            ]);*/

        function plotArray(coords,risks) {

            var circle = L.circle(coords[0],30,{color: 'blue'}).addTo(map);
            var i = coords.length;
            var circle2 = L.circle(coords[i-1],30,{color: 'green'}).addTo(map);
            // var polyline = L.polyline(coords, {color: d3.interpolateLab("red", "yellow")(.5)}).addTo(map);
            //map.fitBounds(polyline.getBounds()); 
            var polylines = [];
            var avg_risk = 0;
            var relativeRisk = d3.scale.linear()
            .domain([0.0,4000.0])
            .range([-1,1]);


            for (var k = 0; k < risks.length-1; k++) {
              avg_risk =  relativeRisk((risks[k]+risks[k+1])/2);
              if (avg_risk<1){
                //if bad, color is on red-yellow
                polyline = L.polyline([coords[k],coords[k+1]],
               {color: d3.interpolateLab("red", "yellow")(avg_risk+1)})
               .addTo(map);
              }
              else{
                //must be good (0,1), so color on yellow-green
                polyline = L.polyline([coords[k],coords[k+1]],
               {color: d3.interpolateLab("yellow", "green")(avg_risk)})
               .addTo(map);
              }
            }  
          };


    </script>
</body>
</html>
